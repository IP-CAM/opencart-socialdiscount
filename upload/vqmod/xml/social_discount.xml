<modification>
	<id>Social Discount VK</id>
	<version>0.1</version>
	<vqmver>2.0.0</vqmver>
	<author>Gennady Telegin, support@itxd.ru</author>

	<file name="catalog/view/theme/*/template/product/product.tpl">
		<operation>
			<search position="before"><![CDATA[
			<?php echo $footer; ?>
			]]></search>
			<add><![CDATA[
<script>
<?php if ($social_discount_vk_like_enabled): ?>
VK.Observer.subscribe("widgets.like.liked", function () {
	sd_userAction('vk','like');
});
VK.Observer.subscribe("widgets.like.unliked", function () {
	sd_userAction('vk','unlike');
});
<?php endif; ?>
<?php if ($social_discount_vk_share_enabled): ?>
VK.Observer.subscribe("widgets.like.shared", function () {
	sd_userAction('vk','share');
});
VK.Observer.subscribe("widgets.like.unpublished", function () {
	sd_userAction('vk','unpublish');
});
<?php endif; ?>

<?php if ($social_discount_fb_like_enabled): ?>
 window.fbAsyncInit = function() {
 
    FB.init({
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      xfbml      : true  // parse XFBML
    });

    //Facebook tracking
    FB.Event.subscribe('edge.create', function(targetUrl) {
        sd_userAction('fb','like');
    });
	
	FB.Event.subscribe('edge.remove', function(targetUrl) {
        sd_userAction('fb','unlike');
    });
  };
<?php endif; ?>

<?php if ($social_discount_gp_like_enabled): ?>
function plusone_share(data) {
	console.log(data.state);
	
	if (data.state == 'on') {
		sd_userAction('gp','like');
	} else {
		sd_userAction('gp','unlike');
	}
}
<?php endif; ?>

<?php if ($social_discount_mm_like_enabled || $social_discount_ok_like_enabled): ?>
mailru.loader.require('api', function(){
   mailru.events.listen(mailru.plugin.events.liked, function(result){
	   /* todo - save ID of liked recored */
	   <?php if ($social_discount_mm_like_enabled): ?>
	   if (result.type == 'mm') {
			sd_userAction('mm','like');
	   }
	   <?php endif; ?>
	   <?php if ($social_discount_ok_like_enabled): ?>
	   if (result.type == 'ok') {
			sd_userAction('ok','like');
	   }
	   <?php endif; ?>
   });

   mailru.events.listen(mailru.plugin.events.unliked, function(result){
	   <?php if ($social_discount_mm_like_enabled): ?>
       if (result.type == 'mm') {
			sd_userAction('mm','unlike');
	   }
	   <?php endif; ?>
	   <?php if ($social_discount_ok_like_enabled): ?>
	   if (result.type == 'ok') {
			sd_userAction('ok','unlike');
	   }
	   <?php endif; ?>
   });
});
<?php endif; ?>

function sd_userAction(soc, action) {
	var product_id = <?php echo $product_id; ?>;
	$.ajax({
		url: '/index.php?route=module/social_discount/action',
		type: 'POST',
		dataType: 'json',
		data: {
			"product_id": product_id,
			"social": soc,
			"action": action
		},
		success: function(data) {
			if (data['success']) {
				if (data['percent'] > 0) {
					$('#priceUpdate1').html(data['discount_price']);
					$('#priceUpdate').addClass('price-old');
					
					if (data['social_discount']) {
						$('#social_discount_active').show();
					} else {
						$('#social_discount_active').hide();
					}
				} else {
					$('#priceUpdate').removeClass('price-old');
					$('#priceUpdate1').html('');
					$('#social_discount_active').hide();
				}
			}
		}
	});
}
</script>
			]]></add>
		</operation>
		
		<operation>
            <search position="replace" index="1"><![CDATA[
            <?php echo $price; ?>
            ]]></search>
            <add><![CDATA[
			<span id="priceUpdate"><?php echo $price; ?></span><span class="price-new" id="priceUpdate1"></span>
			]]></add>
        </operation>
		
		<operation>
            <search position="replace" index="1"><![CDATA[
            <span class="price-old"><?php echo $price; ?></span> <span class="price-new"><?php echo $special; ?></span>
            ]]></search>
            <add><![CDATA[
			<span class="price-old" id="priceUpdate"><?php echo $price; ?></span> <span class="price-new" id="priceUpdate1"><?php echo $special; ?></span>
			]]></add>
        </operation>
		
		<operation>
			<search position="after"><![CDATA[
			<span class="price-new"
			]]></search>
			<add><![CDATA[
			
			<div id="social_discount_active"<?php if ($social_discount == false) { echo ' style="display: none;"'; } else { echo ' style="display: inline-block"'; } ?>><?php echo $social_discount_active_mark; ?></div>
			]]></add>
		</operation>	
		
	</file>
	
	<file name="catalog/controller/product/product.php">
		<operation>
			<search position="before"><![CDATA[
			$this->data['heading_title']
			]]></search>
			<add><![CDATA[
			$this->load->model('catalog/social_discount');
			$discount_percent = $this->model_catalog_social_discount->getDiscountPercentForProduct($product_info['product_id']);
			
			$this->data['social_discount_vk_like_enabled']  = $this->config->get('social_discount_vk_like_enabled');
			$this->data['social_discount_vk_share_enabled'] = $this->config->get('social_discount_vk_share_enabled');
			$this->data['social_discount_fb_like_enabled']  = $this->config->get('social_discount_fb_like_enabled');
			$this->data['social_discount_gp_like_enabled']  = $this->config->get('social_discount_gp_like_enabled');
			$this->data['social_discount_mm_like_enabled']  = $this->config->get('social_discount_mm_like_enabled');
			$this->data['social_discount_ok_like_enabled']  = $this->config->get('social_discount_ok_like_enabled');
			
			$this->data['social_discount_active_mark'] = $this->config->get('social_discount_active_mark');
			]]></add>
		</operation>
		
		
		<operation>
			<search position="after"><![CDATA[
			if ($product_info) {
			]]></search>
			<add><![CDATA[
			$this->data['social_discount'] = $product_info['social_discount'];
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/catalog/product.php">
		<operation>
			<search position="replace"><![CDATA[
			public function getProduct($product_id) {
			]]></search>
			<add><![CDATA[
			public function getProduct($product_id) {
				$this->load->model('catalog/social_discount');
				$discount_method = $this->config->get('social_discount_discount_method');
				
				$product = $this->__getProduct($product_id);
					
				$discount_percent = $this->model_catalog_social_discount->getDiscountPercentForProduct($product['product_id']);
				
				$product['social_discount'] = ($discount_percent > 0);
				
				if ($product['price'] > 0 && $product['special']) {
					$special_percent = ($product['price'] - $product['special']) * 1.0 / $product['price'];
				} else {
					$special_percent = 0;
				}
				
				if ($discount_percent > 0) {
					switch ($discount_method) {
					case 1: // special price
						if ($product['special']) {
							$special = $product['special'] * (1 - $discount_percent);

							$product['social_discount_percent'] = sprintf("%.2f", $special_percent + $discount_percent);
							
							break;
						}
					case 0: // base price
						$product['social_discount_percent'] = $discount_percent;
						
						$discount_value = $product['price'] * $discount_percent;
						
						if ($product['special']) {
							$special = $product['special'] - $discount_value;
						} else {
							$special = $product['price'] - $discount_value;
						}
						
						break;
					}
				
					$product['special'] = $special;
				} else {
					$product['social_discount_percent'] = $special_percent;
				}
				
				return $product;
			}
			
			public function __getProduct($product_id) {
			]]></add>
		</operation>		
	</file>
	
	<file name="admin/controller/catalog/product.php">
		<operation>
			<search position="after"><![CDATA[
			$this->model_catalog_product->editProduct($this->request->get['product_id'], $this->request->post);
			]]></search>
			<add><![CDATA[
			// {{{
			$this->load->model('catalog/social_discount');
			
			$sd_params = array (
				'social_discount_vk_like_enabled' => false,
				'social_discount_vk_like_value' => '',
				'social_discount_vk_share_enabled' => false,
				'social_discount_vk_share_value' => '',
				'social_discount_fb_like_enabled' => false,
				'social_discount_fb_like_value' => '',
				'social_discount_gp_like_enabled' => false,
				'social_discount_gp_like_value' => '',
				'social_discount_mm_like_enabled' => false,
				'social_discount_mm_like_value' => '',
				'social_discount_ok_like_enabled' => false,
				'social_discount_ok_like_value' => '',
			);
			// read settings from module
			foreach ($sd_params as $sd_param_name => $value) {
				$sd_params[$sd_param_name] = $this->config->get($sd_param_name);
			}
			
			$sd_params['social_discount_custom_enabled'] = false; // default value
			
			$sd_custom = $this->model_catalog_social_discount->getCustomSocialDiscount($this->request->get['product_id']);
			
			// get current custom settings for product
			if ($sd_custom != false) {
				$sd_params = array_merge($sd_params, $sd_custom);
			}
			
			// save differences in POST
			$sd_params['social_discount_vk_like_enabled'] = isset($this->request->post['social_discount_vk_like_enabled']) && $this->request->post['social_discount_vk_like_enabled'] == 'on';
			$sd_params['social_discount_vk_share_enabled'] = isset($this->request->post['social_discount_vk_share_enabled']) && $this->request->post['social_discount_vk_share_enabled'] == 'on';
			$sd_params['social_discount_fb_like_enabled'] = isset($this->request->post['social_discount_fb_like_enabled']) && $this->request->post['social_discount_fb_like_enabled'] == 'on';
			$sd_params['social_discount_gp_like_enabled'] = isset($this->request->post['social_discount_gp_like_enabled']) && $this->request->post['social_discount_gp_like_enabled'] == 'on';
			$sd_params['social_discount_mm_like_enabled'] = isset($this->request->post['social_discount_mm_like_enabled']) && $this->request->post['social_discount_mm_like_enabled'] == 'on';
			$sd_params['social_discount_ok_like_enabled'] = isset($this->request->post['social_discount_ok_like_enabled']) && $this->request->post['social_discount_ok_like_enabled'] == 'on';
			
			$sd_params['social_discount_vk_like_value'] = isset($this->request->post['social_discount_vk_like_value']) ? $this->request->post['social_discount_vk_like_value'] : $sd_params['social_discount_vk_like_value'];
			$sd_params['social_discount_vk_share_value'] = isset($this->request->post['social_discount_vk_share_value']) ? $this->request->post['social_discount_vk_share_value'] : $sd_params['social_discount_vk_share_value'];
			$sd_params['social_discount_fb_like_value'] = isset($this->request->post['social_discount_fb_like_value']) ? $this->request->post['social_discount_fb_like_value'] : $sd_params['social_discount_fb_like_value'];
			$sd_params['social_discount_gp_like_value'] = isset($this->request->post['social_discount_gp_like_value']) ? $this->request->post['social_discount_gp_like_value'] : $sd_params['social_discount_gp_like_value'];
			$sd_params['social_discount_mm_like_value'] = isset($this->request->post['social_discount_mm_like_value']) ? $this->request->post['social_discount_mm_like_value'] : $sd_params['social_discount_mm_like_value'];
			$sd_params['social_discount_ok_like_value'] = isset($this->request->post['social_discount_ok_like_value']) ? $this->request->post['social_discount_ok_like_value'] : $sd_params['social_discount_ok_like_value'];

			$sd_params['social_discount_custom_enabled'] = isset($this->request->post['social_discount_custom_enabled']) && $this->request->post['social_discount_custom_enabled'] == 'on';
			
			$this->model_catalog_social_discount->setCustomSocialDiscount($this->request->get['product_id'], $sd_params);
			// }}}
			]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[
			if (isset($this->request->post['product_special'])) {
			]]></search>
			<add><![CDATA[
			// {{{
			$sd_params = array (
				'social_discount_vk_like_enabled' => false,
				'social_discount_vk_like_value' => '',
				'social_discount_vk_share_enabled' => false,
				'social_discount_vk_share_value' => '',
				'social_discount_fb_like_enabled' => false,
				'social_discount_fb_like_value' => '',
				'social_discount_gp_like_enabled' => false,
				'social_discount_gp_like_value' => '',
				'social_discount_mm_like_enabled' => false,
				'social_discount_mm_like_value' => '',
				'social_discount_ok_like_enabled' => false,
				'social_discount_ok_like_value' => '',
			);
			// read settings from module
			foreach ($sd_params as $sd_param_name => $value) {
				$sd_params[$sd_param_name] = $this->config->get($sd_param_name);
			}
			
			$sd_params['social_discount_custom_enabled'] = false; // default value
			
			// get current custom settings for product
			$this->load->model('catalog/social_discount');
			$sd_custom = $this->model_catalog_social_discount->getCustomSocialDiscount($this->request->get['product_id']);
			
			if ($sd_custom) {
				$sd_params = array_merge($sd_params, $sd_custom);
			}
			
			// set values for template
			$this->data = array_merge($this->data, $sd_params);
			// }}}
			]]></add>
		</operation>
	</file>
	
	
	<file name="admin/view/template/catalog/product_form.tpl">
		<operation>
			<search position="after"><![CDATA[
			<div id="tab-special">
			]]></search>
			<add><![CDATA[
			<!-- {{{ -->
			  <h2>Скидка за "лайк":</h2>
			  <input type="checkbox" name="social_discount_custom_enabled" id="social_discount_custom_enabled"<?php echo $social_discount_custom_enabled ? ' checked="checked"' : ''; ?>><label for="social_discount_custom_enabled">Задать особые значения для скидок за действия в социальных сетях</label>
			  
			  <script>
			  $(document).ready(function() {
			  <?php if ($social_discount_custom_enabled == false): ?>
				$('#social_discount_params input').attr('disabled', 'disabled');
			  <?php endif; ?>
				$('#social_discount_custom_enabled').change(function() {
					if ($(this).attr('checked') == 'checked') {
						$('#social_discount_params input').removeAttr('disabled');
					} else {
						$('#social_discount_params input').attr('disabled', 'disabled');
					}
				});
			  });
			  </script>
			  
			  <table id="social_discount_params" class="list" style="width: 350px; margin-top: 15px;">
				<tr>
					<td>VK
					<td>
						<input type="checkbox" name="social_discount_vk_like_enabled" id="social_discount_vk_like_enabled"<?php echo $social_discount_vk_like_enabled ? ' checked="checked"' : ''; ?>/><label for="social_discount_vk_like_enabled">Like</label>
						<input type="text" name="social_discount_vk_like_value" value="<?php echo $social_discount_vk_like_value; ?>" size="1" />%
					</td>
					<td>
						<input type="checkbox" name="social_discount_vk_share_enabled" id="social_discount_vk_share_enabled"<?php echo $social_discount_vk_share_enabled ? ' checked="checked"' : ''; ?>/><label for="social_discount_vk_share_enabled">Share</label>
						<input type="text" name="social_discount_vk_share_value" value="<?php echo $social_discount_vk_share_value; ?>" size="1" />%
					</td>
				</tr>
				<tr>
					<td>Facebook
					<td>
						<input type="checkbox" name="social_discount_fb_like_enabled" id="social_discount_fb_like_enabled"<?php echo $social_discount_fb_like_enabled ? ' checked="checked"' : ''; ?>/><label for="social_discount_fb_like_enabled">Like</label>
						<input type="text" name="social_discount_fb_like_value" value="<?php echo $social_discount_fb_like_value; ?>" size="1" />%
					</td>
					<td>
						
					</td>
				</tr>
				
				<tr>
					<td>Google Plus
					<td>
						<input type="checkbox" name="social_discount_gp_like_enabled" id="social_discount_gp_like_enabled"<?php echo $social_discount_gp_like_enabled ? ' checked="checked"' : ''; ?>/><label for="social_discount_gp_like_enabled">Like</label>
						<input type="text" name="social_discount_gp_like_value" value="<?php echo $social_discount_gp_like_value; ?>" size="1" />%
					</td>
					<td>
						
					</td>
				</tr>
				
				<tr>
					<td>Мой Мир
					<td>
						<input type="checkbox" name="social_discount_mm_like_enabled" id="social_discount_mm_like_enabled"<?php echo $social_discount_mm_like_enabled ? ' checked="checked"' : ''; ?>/><label for="social_discount_mm_like_enabled">Like</label>
						<input type="text" name="social_discount_mm_like_value" value="<?php echo $social_discount_mm_like_value; ?>" size="1" />%
					</td>
					<td>
						
					</td>
				</tr>
				
				<tr>
					<td>Одноклассники
					<td>
						<input type="checkbox" name="social_discount_ok_like_enabled" id="social_discount_ok_like_enabled"<?php echo $social_discount_ok_like_enabled ? ' checked="checked"' : ''; ?>/><label for="social_discount_ok_like_enabled">Like</label>
						<input type="text" name="social_discount_ok_like_value" value="<?php echo $social_discount_ok_like_value; ?>" size="1" />%
					</td>
					<td>
						
					</td>
				</tr>
				</table>
					
			  <h2>Другие акции:</h2>
			  <!-- }}} -->
			]]></add>
		</operation>
	</file>
</modification>
